<style>

    #container-map {position: relative;min-height: 420px;}
    #map {margin-left: 0px;height: 400px;margin-right:320px}
    .ib {display: inline-block}
    .fl-left {float: left}
    .a-right {text-align: right}
    .info h2.title {color: #e02b20;padding: 0;margin: 5px 0;font-size: 16px;font-weight: bold;}
    .info p {font-size: 14px;color: #2e3e40}
    a.type-place {position: relative;line-height:25px}
    a.type-place i.fa{font-size:14px;width:25px;line-height:25px;border-radius:50%;background:#fff;color:#e02b20;margin-right:10px;text-align:center}
    a.type-place:hover i.fa,a.type-place.active i.fa{background:#e02b20;color:#fff}
    a.type-place.loading{opacity:.6}
    a.type-place.loading i.fa:before{content:"\f013" !important}
    #places-available{padding-top:5px;padding-bottom:0}
    #places-available p {margin:0}
    .btn-mr.btn-small.ctrl{font-size:11px !important}
    a.type-place .next {
        position: absolute;
        right: 0;
        top: 4px;
        height: 22px;
        z-index: 1;
        display: none;
        width: 22px;
        text-align: center;
        color: #fff;
        font-size: 30px;
        line-height: 20px;
        background: #e02b20;
        border-radius: 10px;
        content: "+"
    }

    a.type-place .next:hover {opacity: .7}
    a.type-place.hasnext.active .next {display: block}
    a.type-place.loading .next {opacity: .5}

    .panel {margin-bottom: 0 !important}

    .well{min-height:100px}
    div[style*="font-family: LABEL_SELECTED"], div[style*="font-family: LABEL_SELECTED"][style]{background:#fff;color:#fff}
    
    .gm-style-iw.gm-style-iw-c .gm-ui-hover-effect,.gm-style-iw.gm-style-iw-c .gm-ui-hover-effect[style]{margin:10px 10px 0 0 !important;}
    .gm-style-iw.gm-style-iw-c .gm-ui-hover-effect img,.gm-style-iw.gm-style-iw-c .gm-ui-hover-effect img[style]{width: auto !important;height:auto !important;margin:0 !important}

    #places-available{width:320px}
    #range-slider{left: 50%; width: 500px; margin-left: -415px;}
    #range-slider .slider-tick {width: 20px; height: 20px;opacity:1}
    .slider-tick-label-container{display:none}
    .gm-style .gm-style-iw-c{padding:0 !important}
    
    #mr-logo{display:none}
    .pdfcontainer #mr-logo{display:block}
    
    
    @media print {
        @page {size: portrait}
        #map{margin-right:0;height:40%}
        .pdfignore,.gm-style-iw.gm-style-iw-c{display:none}
        .well{border:1px solid #ccc}
        .col-md-5.col-lg-5{width:100%;float:none;clear:both;box-sizing:border-box;margin:0 !important;padding:0 !important;margin-bottom:10px}
        #mr-logo{display:block;text-align:center;margin-bottom:10px;margin-top:0}
        .col-md-12.p-15.bg-data *,
        .col-sm-6.col-xs-12.p-15 *{display:inline-block !important;width:auto !important;line-height:30px}
        .col-md-12.p-15,.col-sm-6.col-xs-12.p-15{padding-top:0;padding-bottom:0}
    }

</style>

<div class="container-fluid bg-light-gray hide">
    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <div class="media py-10">
                    <div class="media-left media-middle br-light-1" href="#">
                        <img class="media-object" src="assets/img/logo-text.png" alt="AdMove">
                    </div>
                    <div class="media-body">
                        <p class="m-0 px-10 color-dark-blue"><span class="badge bg-gray pull-left mr-10"><i>i</i></span>La circonferenza può essere diversa dall'area considerata efficace per la pianificazione</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="pdfpage">

    <div id="container-map">
        <div id="mr-logo"><img class="logo mCS_img_loaded" src="assets/img/logo.png" alt="AdMove.com"></div>
        <div id="map" class="with-sidebar"></div>
        <div class="pdfignore">
            <input id="map-range" data-slider-id='range-slider' type="text" data-slider-value="1000" />
            <div id="places-available" data-mcs-theme="minimal-dark">
                <p class="fs-24 pdfignore">Attività sul territorio:</p>
            </div>
        </div>
    </div>

    <div class="container pt-15" id="container-pdv">

        <div class="row">
            <script id="business-template" type="text/x-handlebars-template">
                <div class="col-md-5 col-lg-5">
                    <div class="well">
                        <div class="media" style="overflow: visible;">
                            <div class="media-left media-middle" style="background:#f1f1f1;border-radius:10px;padding:0 10px;">
                                <img class="media-object static-img" src="assets/img/logo.png" alt="Mondored.it" style="height:40px;margin:0">
                            </div>
                            <div class="media-body media-middle bg-pdv" style="padding-left:10px">

                                <h3 class="color-red fs-18 m-0 mb-10"><b data-insegna>{{businessName}}</b></h3>

                                <div class="media m-0">
                                    <div class="media-left">
                                        <i class="fas fa-map-marker-alt color-red"></i>
                                    </div>
                                    <p class="media-body"><span class="pdi-address fs-13">{{address}}</span></p>
                                </div>

                                <div class="media m-0">
                                    <div class="media-left">
                                        <span class="media-object color-red"><b>T:</b></span>
                                    </div>
                                    <p class="media-body"><span class="pdi-phone">{{phoneNumber}}</span></p>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>
            </script>

            <div class="col-md-5 col-lg-5">
                <div class="well pt-0 pb-0">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="row">
                                <div class="col-md-12 p-15 bg-data">

                                    <div class="clearfix">
                                        <span class="text-uppercase color-light-gray fs-13 pull-left lh-18 mr-5">Media mobile users daily</span>
                                        <!--i class="fas fa-question-circle color-red c-help pull-left" data-toggle="tooltip" data-placement="top" title="Questi sono gli utenti mobile raggiungibili per una campagna efficace. L'area può essere diversa da quella mostrata."></i-->
                                    </div>

                                    <div class="media">
                                        <div class="media-body">
                                            <span class="fs-26 color-red" data-insight-PotentialUsers="">26.250</span>
                                        </div>
                                    </div>

                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="row">
                                <div class="col-sm-6 col-xs-12 p-15 br-light-1 bg-men">

                                    <div class="clearfix">
                                        <span class="text-uppercase color-red f-light pull-left mr-10 fs-14 lh-18">Uomini</span>
                                    </div>

                                    <div class="media">
                                        <div class="media-body">
                                            <span class="fs-26" data-insight-MaleStats="">49.210</span>
                                        </div>
                                    </div>

                                </div>

                                <div class="col-sm-6 col-xs-12 p-15 bg-women">

                                    <div class="clearfix">
                                        <span class="text-uppercase color-red f-light pull-left mr-10 fs-14 lh-18">Donne</span>
                                    </div>

                                    <div class="media">
                                        <div class="media-body">
                                            <span class="fs-26" data-insight-FemaleStats="">23.515</span>
                                        </div>
                                    </div>

                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>

            <div class="col-md-2 col-lg-2 box-action">
                <div class="row mb-20 pdfignore">
                    <div class="col-md-12 col-xs-6 text-center">
                        <button class="btn btn-mr btn-small btn-back text-uppercase mb-15">Indietro</button>
                    </div>
                    <div class="col-md-12 col-xs-6 text-center">
                        <a class="btn btn-mr btn-small circle text-uppercase pdf mb-15">Salva <span class="circle-btn"><i class="fas fa-image"></i></span></a>
                    </div>
                </div>
            </div>

        </div>

    </div>

</div> <!-- end pdfpage -->
<script src="assets/js/simpleslider.min.js"></script>
<script src="assets/js/pdf/dist/jspdf.debug.js"></script>
<script src="assets/js/pdf/html2pdf.js"></script>
<script src="assets/bootstrap-slider/js/bootstrap-slider.min.js"></script>
<script>

    Number.prototype.format = function(n, x, s, c, suffix) {
        var re = '\\d(?=(\\d{' + (x || 3) + '})+' + (n > 0 ? '\\D' : '$') + ')',
            num = this.toFixed(Math.max(0, ~~n));
        
        return (c ? num.replace('.', c) : num).replace(new RegExp(re, 'g'), '$&' + (s || '.')) + (suffix || '');
    };

    var currentPage;
    $(document).ready(function () {

        currentPage = navigationService.currentPage;

        function mapSize($target) {
            var wH = $( window ).height(), wW = $( window ).width(), cH = $("#container-pdv").outerHeight();

            var h = wH - cH;

            if (h <= 400) { h = 400; }
            if (wW < 992) { h = 480; }

            $target.css("height", h);
        };

        $(window).on("resize", function () {
            mapSize($("#map"));
        }).trigger("resize");

        // imposto le variabili
        var body = currentPage.html,
            pdis = $("#owl-dashboard .owl-stage"), // slider
            pdiArea = $("#insights"), // insights
            pdiBudget = $("#prices"), // budget
            carousel_pdi_template = $("#owl-dashboard .row.item:first").removeClass("hide").remove(),
            ignore_trigger = false,
            modal = null;

        // tooltip di bootstrap
        $("[data-toggle=tooltip]").tooltip({container: 'body'});

        // carousel del budget
        var carousel_prices = $("#owl-price");
        carousel_prices.owlCarousel({
            loop: true,
            mouseDrag: false,
            nav: true,
            margin: 30,
            items: 1,
            navText: ["", ""]
        });

        CMS.loadPlugin("../assets/js/plugin/pdf", function (plugin) {

            if (!plugin) return $("a.pdf").addClass("disabled");

            plugin.init(body);

        });
        
        //var rs = body.find('input[type=range]');
        
        /* Slider Range */
        $("#map-range").slider({
            tooltip: 'always',
            min: 500,
            max: 5000,
            step: 500,
            ticks: [500, 1000, 1500, 2000, 2500, 3000, 3500, 4000, 4500, 5000],
            ticks_positions: [0, 11, 22, 33, 44, 55, 66, 77, 88, 100],
            //ticks_labels: ['500 mt', '1000 mt', '1500 mt', '2000 mt', '2500 mt', '3000 mt', '3500 mt', '4000 mt', '4500 mt', '5000 mt'],
            ticks_snap_bounds: 0,
            formatter: function(value) {
        		return value + ' mt';
        	},
        });
        
        

        CMS.loadPlugin("../assets/js/plugin/maps", function (plugin) {

            if (!plugin) return BootstrapDialog.alert("Impossibile caricare il plugin"); // errore nel caricamento

            plugin.icons = "../assets/img/maps/";

            var service = null;

            var types = {
                "movie_theater": { "name": "Cinema", "path": "cinema-teatro.png", ico: 'fa fas fa-film' },
                "stadium": { "name": "Stadi", "path": "stadio.png", ico: 'fa fas fa-cube' },
                "airport": { "name": "Aeroporti", "path": "aeroporto.png", ico: 'fa fas fa-plane' },
                "gym": { "name": "Palestre", "path": "palestra.png", ico: 'fa fas fa-dumbbell' },
                "book_store": { "name": "Librerie", "path": "libreria.png", ico: 'fa fas fa-book' },
                "hair_care": { "name": "Parrucchieri", "path": "parrucchiere.png", ico: 'fa fas fa-cut' },
                "department_store": { "name": "Centri commerciali", "path": "centro-commerciale.png", ico: 'fa fas fa-shopping-cart' },        
                "beauty_salon": { "name": "Centri estetici", "path": "salone-bellezza.png", ico: 'fa fas fa-spa' },
                "restaurant": { "name": "Ristoranti", "path": "ristorante.png", ico: 'fa fas fa-utensils' },
                "bar": { "name": "Bar", "path": "caffe.png", types: ["bar", "cafe"], ico: 'fa fas fa-coffee' }
            }, _get_type = function (t) {
                if (types[t] && types[t].types) return types[t].types;
                return [t];
            }, _get_path = function (t) {
                if (t == "cafe") t = "bar";
                if (types[t]) return "../assets/img/maps/place/" + types[t].path;
                return "404_" + t;
            }, _set_zoom = function (radius) {
                radius = parseInt(radius);
                if (radius <= 500) {
                    return 17;
                } else if (radius > 500 && radius < 1500) {
                    return 16;
                } else {
                    return 15;
                }
            };


            var _markers = {}, _clearMarkers = function (type) {

                if (type) {
                    var _types = _get_type(type);
                    for (var tt = 0; tt < _types.length; tt++) {
                        if (_markers[_types[tt]]) {
                            for (var m = 0; m < _markers[_types[tt]].length; m++) _markers[_types[tt]][m].setMap(null);
                            _markers[_types[tt]] = [];
                        }
                        $(".panel [data-type=" + type + "]").removeClass("active").removeClass("loading").addClass("nomore");
                    }
                    return false;
                }

                $(".panel .active").removeClass("active").removeClass("loading").addClass("nomore");

                for (var t in _markers) {
                    for (var m = 0; m < _markers[t].length; m++) _markers[t][m].setMap(null);
                    _markers[t] = [];
                }

            }, _addMarker = function (latLng, type, map, icon, title) {

                var marker = new google.maps.Marker({
                    position: latLng,
                    icon: {
                        url: _get_path(type),
                        scaledSize: new google.maps.Size(30, 30),
                        anchor: new google.maps.Point(15, 15)
                    },
                    title: title,
                    map: map
                });
                //console.log("DONE MARK");
                if (!_markers[type]) _markers[type] = [];
                _markers[type].push(marker);
                //console.log(_markers);

            }, _search = function (lat, lng, radius, type, callback, pagetoken) {

                if (!service) return;

                service.nearbySearch({
                    location: { lat: lat, lng: lng },
                    radius: radius,
                    type: type
                }, function (results, status, pagination) {
                    callback(results, status, type, pagination);
                });

            };


            var panel = $('<div class="panel"><div class="row pdfignore"><div class="col-xs-6 mt-15 mb-15"><a data-type="clear" title="Cancella tutto" class="btn btn-mr btn-white btn-small clear ctrl ml-5 text-uppercase">Cancella tutto</a></div> <div class="col-xs-6 mt-15 mb-15"><a data-type="all" title="Attiva tutto" class="btn btn-mr btn-small light all ctrl mr-5 text-uppercase">Attiva tutto</a></div></div></div>');

            for (var t in types) panel.prepend('<a data-type="' + t + '" class="text-uppercase type-place" title="Attiva ' + types[t].name + '"><i class="'+types[t].ico+'"></i>' + types[t].name + '<span class="status"></span></a>'); //<span class="next" data-toggle="tooltip" data-placement="left" title="Aggiungi i prossimi risultati">+</span>

            panel.find("[data-toggle=tooltip]").tooltip();

            $("#places-available").append(panel).on("click", "[data-type]", function () {
                var t = $(this).removeClass("nomore"), type = t.data("type");
            });
            $("#places-available").append(panel).on("click", "[data-type]", function () {
                var t = $(this), type = t.data("type");
                if (t.hasClass("loading")) return false;
                if (t.hasClass("active")) {

                    return _clearMarkers(type);
                    
                }

                var pdi = plugin.getSelected();

                if (type == "all") {
                    $(".panel [data-type]").removeClass("hasnext");
                    $(".panel [data-type]:not(.ctrl):not(.active)").each(function (i, e) {
                        var _t = $(this), _type = _t.data("type"), _types = _get_type(_type);

                        for (var tt = 0; tt < _types.length; tt++) {
                            var type_ = _types[tt];
                            setTimeout(function () {
                                _search(pdi.circle.lat, pdi.circle.lng, pdi.circle.radius, type_, function (results, status, type_, pagination) {
                                    _t.removeClass("loading").addClass("active").removeClass("hasnext").find('.fa').removeClass('fa-spin');
                                    if (status != "OK") return;

                                    if (_t.hasClass("nomore")) return _t.removeClass("nomore").removeClass("active");

                                    for (var r = 0; r < results.length; r++) _addMarker(results[r].geometry.location, type_, plugin.map, results[r].icon, results[r].name + " " + results[r].vicinity);

                                    if (pagination.hasNextPage) {

                                        pagination.nextPage();

                                    }

                                });
                            }, 100 * i);
                        }

                    }).addClass("loading").find('.fa').addClass('fa-spin');

                    return false;

                } else if (type == "clear") {
                    return _clearMarkers();
                }

                t.addClass("loading").find('.fa').addClass('fa-spin');

                _search(pdi.circle.lat, pdi.circle.lng, pdi.circle.radius, type, function (results, status, type, pagination) {
                    t.removeClass("loading").addClass("active").removeClass("hasnext").find('.fa').removeClass('fa-spin');
                    if (status != "OK") return;
                    if (t.hasClass("nomore")) return t.removeClass("nomore").removeClass("active");
                    for (var r = 0; r < results.length; r++) _addMarker(results[r].geometry.location, type, plugin.map, results[r].icon, results[r].name + " " + results[r].vicinity);
                    //console.log(pagination);
                    if (pagination.hasNextPage) {

                        pagination.nextPage();

                    }
                });
            });

            $("#places-available").mCustomScrollbar();

            currentPage.onUpdatePdv = function (res) {
                var pdi = plugin.getPoint(res.id);
                if (!pdi) return BootstrapDialog.alert("Il punto non è stato trovato");

                // aggiorno i dati
                pdi.insights.data = res.insights.data;
                pdi.title = res.title;

                if (plugin.getSelected().id === res.id) {
                    // aggiorno tutti i dati di insights
                    console.log("prima chiamata updateInsight");
                    updateInsights(pdi);
                }

                try {
                    pdi.changeLocation(res.lat, res.lng, pdi.circle.radius);
                } catch (e) {
                    BootstrapDialog.alert("Impossibile aggiornare il punto: " + e.message);
                }
            }

            function updateInsights(pdi) {
                if (!pdi.insights.data || $.isEmptyObject(pdi.insights.data)) pdi.insights.data = { PotentialUsers: "-", MaleStats: "-", FemaleStats: "-", PublicOfficesNumber: 0, PrivatesNumber: 0, PublicTransportNumber: 0, Ranking: [3, 6, 7] };
                $("[data-insight-PotentialUsers]").text(parseInt(pdi.insights.data.PotentialUsers).format());
                $("[data-insight-MaleStats]").text(parseInt(pdi.insights.data.MaleStats).format());
                $("[data-insight-FemaleStats]").text(parseInt(pdi.insights.data.FemaleStats).format());
                
                console.log('insights: ',pdi.insights);
            }
            function updateInsightsRadius(aux) {
                if (!aux) {
                    $("[data-insight-PotentialUsers]").text("-");
                    $("[data-insight-MaleStats]").text("-");
                    $("[data-insight-FemaleStats]").text("-");
                } else {
                    $("[data-insight-PotentialUsers]").text(parseInt(aux.PotentialUsers).format());
                    $("[data-insight-MaleStats]").text(parseInt(aux.MaleStats).format());
                    $("[data-insight-FemaleStats]").text(parseInt(aux.FemaleStats).format());
                }
            }

            // inizializzo il plugin
            // la funzione di callback è sempre richiamata per ogni genere di evento propagato
            plugin.init("map", { lat: 45.4637307, lng: 9.1910625, zoom: 11 }, function (evt, pdi) { // callback eventi
                if (!service) {
                    service = new google.maps.places.PlacesService(plugin.map);
                }

                if (!pdi && evt != "add-pdi") return false;

                if (evt == "update") {
                    currentPage.updatePdi(pdi.id);
                    return false;
                } else if (evt == "added") { // punto aggiunto. Aggiorno slider
                    //cambio zoom mappa
                    setTimeout(function () {
                        plugin.map.setZoom(_set_zoom(pdi.circle.radius));
                    }, 100);
                } else if (evt == "updated") { // punto aggiornato/ripristinato. invio richiesta
                    // chiamata di aggiornamento dei dati di insights
                    updateInsights(pdi);
                    setTimeout(function () {
                        plugin.map.setZoom(_set_zoom(pdi.circle.radius));
                    }, 100);
                } else if (evt == "resetted") {
                    _clearMarkers();
                    currentPage.pdiReset(pdi.id);
                    setTimeout(function () {
                        plugin.map.setZoom(_set_zoom(pdi.circle.radius));
                    }, 100);
                } else if (evt == "selected") { // elemento selezionato
                    // imposto l"id del punto in caso di aggiornamento dell"indirizzo
                    pdiArea.find("[name=id]").val(pdi.id);

                    // aggiorno tutti i dati di insights
                    updateInsights(pdi);
                    var aux = currentPage.readinsightRadiusValues(pdi.circle.radius);
                    updateInsightsRadius(aux);                    
                } else if (evt == "dragend") {
                    currentPage.pdiMoved(pdi.id, { lat: pdi.circle.lat, lng: pdi.circle.lng });
                    _clearMarkers();
                }
            });

            var pdi = currentPage.userSession.pdvs[0].mapItem;
            pdi.duplicable = false;
            pdi.cancelable = false;
            pdi.resettable = false;
            pdi.mouseDrag = false;
            pdi.selected = true;
            pdi.editable = false;
            pdi.circle = { radius: currentPage.userSession.flow3.radius };
            plugin.actions("add", false, pdi);

            // imposto un listener per i bottoni dei punti (quello di aggiunta e quelli della finestra del punto)
            // le azioni saranno dirottate verso la callback dell'inizializzazione
            body.on("click", "a[data-maps]:not(.disable)", function (evt) {

                var b = $(this), evt = b.data("maps"), id = b.data("id");

                plugin.actions(evt, id, null);

            });
            
            $("#map-range").on("slide change", function(slideEvt) {
                //console.log(slideEvt.value);
                if(!slideEvt || !slideEvt.value) return false;
                if(slideEvt.value.newValue) slideEvt.value = slideEvt.value.newValue;
                var pdi = plugin.getSelected();
                if(pdi){
                    pdi.circle.radius = slideEvt.value;
                    pdi.update();
                    plugin.fitBounds(pdi);
                    $("#places-available").find('.active').trigger('click').trigger('click');
                    var aux = currentPage.readinsightRadiusValues(pdi.circle.radius);
                    updateInsightsRadius(aux);
                    //plugin.actions("update", pdi.id, pdi);
                }
            });



        });

    });

    // plugin scrollbar
    $(window).on("load", function () {
        $("#sidebar-dashboard").mCustomScrollbar();
    });

</script>